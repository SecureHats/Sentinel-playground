{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Amarnath Pamidi - v-ampami@microsoft.com",
    "comments": "Solution template for McAfeeePO"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[parameters('location')]",
      "metadata": {
        "description": "Region to deploy solution resources"
      }
    },
    "workspace": {
      "defaultValue": "<Enter Log Analytics Workspace>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "McAfeeePO",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic10-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic11-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic12-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic13-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic14-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "940521d6-cad1-47e7-8ec1-31d3a1eaf67a"
    }
  },
  "variables": {
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]"
  },
  "resources": [
    {
      "name": "pid-94bb245e-f8fe-4cc6-90f9-54b0c098802b-partnercenter",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    },
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2020-02-12",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**NOTE**:This data connector depends on a parser based on Kusto Function to work as expected [**McAfeeEPOEvent**](https://aka.ms/sentinel-McAfeeePO-parser) which is deployed with the Azure Sentinel Solution.\"},\"name\":\"text - 2\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"24d0a087-55d0-4205-b17f-59866e20d7d4\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Event Overview\",\"subTarget\":\"ma_events\",\"style\":\"link\"},{\"id\":\"b8caadb4-a5ef-4e30-9611-45fd2ac1fa46\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Threats\",\"subTarget\":\"ma_threats\",\"style\":\"link\"}]},\"customWidth\":\"100\",\"name\":\"links - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"3b79a6c4-43ca-48f8-8010-18ab3056bec3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"value\":{\"durationMs\":604800000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":900000},{\"durationMs\":3600000},{\"durationMs\":43200000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"100\",\"name\":\"parameters - 3\",\"styleSettings\":{\"margin\":\"0\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\",\"size\":0,\"title\":\"Events Over Time\",\"color\":\"turquoise\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\",\"chartSettings\":{\"showMetrics\":false}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_events\"},\"customWidth\":\"45\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| summarize Count = count() by EventSeverity\\r\\n| join kind = inner (McAfeeEPOEvent\\r\\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EventSeverity)\\r\\n on EventSeverity\",\"size\":3,\"title\":\"Event Distribution by Severity\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"EventSeverity\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"purpleDark\"}},\"showBorder\":false}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_events\"},\"customWidth\":\"30\",\"name\":\"query - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| summarize TotalEvents = count() by EventSeverity\",\"size\":3,\"title\":\"EventSeverity Distribution\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"showMetrics\":false}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_events\"},\"customWidth\":\"25\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| summarize TotalEvents = count() by DvcIpAddr\\r\\n| top 10 by TotalEvents\\r\\n\",\"size\":0,\"title\":\"Top 10 Sources\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_events\"},\"customWidth\":\"33\",\"name\":\"query - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| where isnotempty(SrcDvcOs)\\r\\n| summarize TotalEvents = count() by SrcDvcOs\\r\\n| top 10 by TotalEvents\",\"size\":3,\"title\":\"Events Distribution by OS\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_events\"},\"customWidth\":\"33\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| where isnotempty(AgentVersion)\\r\\n| summarize Agents = dcount(DvcIpAddr) by AgentVersion\",\"size\":0,\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_events\"},\"customWidth\":\"33\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| where isnotempty(ThreatName)\\r\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Threats over Time\",\"color\":\"redBright\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"areachart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_threats\"},\"customWidth\":\"50\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| summarize Count = count() by ThreatCategory\\r\\n| join kind = inner (McAfeeEPOEvent\\r\\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ThreatCategory)\\r\\n on ThreatCategory\",\"size\":0,\"title\":\"Threats by Category\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ThreatCategory\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"redDark\"}},\"showBorder\":false}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_threats\"},\"customWidth\":\"50\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| where isnotempty(ThreatName)\\r\\n| where ThreatName != '_'\\r\\n| summarize TotalEvents = count() by ThreatName\\r\\n| order by TotalEvents desc\\r\\n| top 10 by TotalEvents\\r\\n\",\"size\":0,\"title\":\"Top 10 Threats\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_threats\"},\"customWidth\":\"60\",\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| where isnotempty(ThreatName)\\r\\n| where ThreatName != '_'\\r\\n| summarize TotalEvents = count() by ThreatName\\r\\n| sort by TotalEvents desc\\r\\n\",\"size\":0,\"title\":\"Top Threats\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"rowLimit\":50,\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_threats\"},\"customWidth\":\"40\",\"name\":\"query - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| where isnotempty(ThreatName)\\r\\n| where ThreatName != '_'\\r\\n| order by TimeGenerated desc\\r\\n| summarize EventTime = max(TimeGenerated) by ThreatName, DvcIpAddr\",\"size\":0,\"title\":\"Latest Threats by Source\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"rowLimit\":50,\"filter\":true}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_threats\"},\"customWidth\":\"40\",\"name\":\"query - 13\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| where isnotempty(AnalyzerRuleName)\\r\\n| summarize TotalEvents = count() by AnalyzerRuleName\\r\\n\",\"size\":3,\"title\":\"Rules Fired\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_threats\"},\"customWidth\":\"25\",\"name\":\"query - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"McAfeeEPOEvent\\r\\n| where isnotempty(AnalyzerRuleName)\\r\\n| order by TimeGenerated\\r\\n| summarize by AnalyzerRuleName, DvcIpAddr\",\"size\":0,\"title\":\"Latest Rules Fired\",\"timeContext\":{\"durationMs\":604800000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"ma_threats\"},\"customWidth\":\"33\",\"name\":\"query - 15\"}],\"fromTemplateId\":\"sentinel-McAfeeePO\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when AgentHandler is down.",
        "displayName": "McAfee ePO - Agent Handler down",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId == '16025'\n| extend IPCustomEntity = DvcIpAddr, HostCustomEntity = DvcHostname\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when error sending alert occurs.",
        "displayName": "McAfee ePO - Error sending alert",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId == '1062'\n| extend IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects attempts uninstalling McAfee agent on host.",
        "displayName": "McAfee ePO - Attempt uninstall McAfee agent",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId == '2413'\n| extend IPCustomEntity = DvcIpAddr, HostCustomEntity = DvcHostname\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic4-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when errors occur during deployment new changes/policies.",
        "displayName": "McAfee ePO - Deployment failed",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId == '2412'\n| extend IPCustomEntity = DvcIpAddr, HostCustomEntity = DvcHostname\n",
        "queryFrequency": "PT6H",
        "queryPeriod": "PT6H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic5-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when file was added to exception list on a host.",
        "displayName": "McAfee ePO - File added to exceptions",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId in ('1029', '2005', '2015')\n| project DvcIpAddr, DstFileName\n| extend IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic6-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when firewall was disabled from Mctray.",
        "displayName": "McAfee ePO - Firewall disabled",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId in ('35009')\n| extend IPCustomEntity = DvcIpAddr, HostCustomEntity = DvcHostname\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion",
          "CommandAndControl"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic7-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when logging errors on agent.",
        "displayName": "McAfee ePO - Logging error occurred",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId in ('1040', '1076', '3032', '3033', '3034', '3036', '3038')\n| extend EventMessage = case(EventId == '1040', 'Activity Log error',\n                              EventId == '1076', 'Error logging information',\n                              EventId == '3032', 'Error while trying to open/create activity log file',\n                              EventId == '3033', 'Activity log file maximum size reached',\n                              EventId == '3034', 'Unable to write the activity log file',\n                              EventId == '3036', 'Error during initialization of the activity log file',\n                              'Error writing to log')\n| project DvcIpAddr, EventId, EventMessage\n| extend IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic8-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Rule fires when multiple threat events were detected on the same host.",
        "displayName": "McAfee ePO - Multiple threats on same host",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where isnotempty(ThreatName)\n| where ThreatName != '_'\n| summarize th_cnt = dcount(ThreatName), th_list = makeset(ThreatName) by DvcIpAddr\n| where th_cnt > 1\n| extend IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Persistence",
          "DefenseEvasion",
          "PrivilegeEscalation"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic9-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when OAS scanning engine was disabled.",
        "displayName": "McAfee ePO - Scanning engine disabled",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId == '1127'\n| extend IPCustomEntity = DvcIpAddr, HostCustomEntity = DvcHostname\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Low",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic10-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when email was marked as spam.",
        "displayName": "McAfee ePO - Spam Email detected",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId == '4650'\n| extend IPCustomEntity = DvcIpAddr, HostCustomEntity = DvcHostname\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic11-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when task error occurs.",
        "displayName": "McAfee ePO - Task error",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId in ('1003', '1067')\n| extend EventMessage = case(EventId == '1003', 'Error starting Task',\n                              'Unable to start scheduled task')\n| project DvcIpAddr, EventId, EventMessage\n| extend IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic12-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when a threat was not blocked on a host.",
        "displayName": "McAfee ePO - Threat was not blocked",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where ThreatActionTaken in~ ('none', 'IDS_ACTION_WOULD_BLOCK')\n| extend IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "PrivilegeEscalation",
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic13-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when McAfee failed to clean or delete infected file.",
        "displayName": "McAfee ePO - Unable to clean or delete infected file",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId in ('1026', '1028', '1298', '1310', '1055', '2002', '2004', '2009')\n| extend EventMessage = case(EventId == '1026', 'Unable to clean infected file',\n                              EventId == '1028', 'Unable to delete infected file',\n                              EventId == '1298', 'File infected. Delete failed, quarantine failed',\n                              EventId == '1310', 'Multiple extension heuristic detection - delete failed, quarantine failed',\n                              EventId == '1055', 'Unable to delete infected file',\n                              EventId == '2002', 'Unable to clean infected file',\n                              EventId == '2004', 'Unable to delete infected file',\n                              'Unable to move infected file to quarantine')\n| project DvcIpAddr, EventId, EventMessage, DstFileName\n| extend IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic14-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when update failed event occurs on agent.",
        "displayName": "McAfee ePO - Update failed",
        "enabled": false,
        "query": "McAfeeEPOEvent\n| where EventId in ('2402', '1119', '1123')\n| extend IPCustomEntity = DvcIpAddr, HostCustomEntity = DvcHostname\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "McAfee ePolicy Orchestrator (ePO) (Preview)",
          "publisher": "McAfee",
          "descriptionMarkdown": "The McAfee ePolicy Orchestrator data connector provides the capability to ingest [McAfee ePO](https://www.mcafee.com/enterprise/en-us/products/epolicy-orchestrator.html) events into Azure Sentinel through the syslog. Refer to [documentation](https://docs.mcafee.com/bundle/epolicy-orchestrator-landing/page/GUID-0C40020F-5B7F-4549-B9CC-0E017BC8797F.html) for more information.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "McAfeeePO",
              "baseQuery": "McAfeeEPOEvent"
            }
          ],
          "sampleQueries": [
            {
              "description": "Top 10 Sources",
              "query": "McAfeeEPOEvent\n | summarize count() by DvcHostname\n | top 10 by count_"
            }
          ],
          "dataTypes": [
            {
              "name": "Syslog(McAfeeePO)",
              "lastDataReceivedQuery": "McAfeeEPOEvent\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "McAfeeEPOEvent\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "write permission is required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "delete": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This data connector depends on a parser based on Kusto Function to work as expected [**McAfeeEPOEvent**](https://aka.ms/sentinel-McAfeeePO-parser) which is deployed with the Azure Sentinel Solution."
            },
            {
              "description": "Typically, you should install the agent on a different computer from the one on which the logs are generated.\n\n>  Syslog logs are collected only from **Linux** agents.",
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Linux Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Linux Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ],
              "title": "1. Install and onboard the agent for Linux"
            },
            {
              "description": "Configure the facilities you want to collect and their severities.\n\n1.  Under workspace advanced settings **Configuration**, select **Data** and then **Syslog**.\n2.  Select **Apply below configuration to my machines** and select the facilities and severities.\n3.  Click **Save**.",
              "instructions": [
                {
                  "parameters": {
                    "linkType": "OpenAdvancedWorkspaceSettings"
                  },
                  "type": "InstallAgent"
                }
              ],
              "title": "2. Configure the logs to be collected"
            },
            {
              "description": "[Follow these instructions](https://docs.mcafee.com/bundle/epolicy-orchestrator-5.10.0-product-guide/page/GUID-5C5332B3-837A-4DDA-BE5C-1513A230D90A.html) to add register syslog server.",
              "title": "3. Configure McAfee ePolicy Orchestrator event forwarding to Syslog server"
            }
          ],
          "additionalRequirementBanner": "This data connector depends on a parser based on Kusto Function to work as expected [**McAfeeEPOEvent**](https://aka.ms/sentinel-McAfeeePO-parser) which is deployed with the Azure Sentinel Solution."
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfeeePO Data Parser",
            "category": "SecureHats",
            "functionAlias": "McAfeeEPOEvent",
            "query": "\nlet mcafee_epoevent =() {\nSyslog_CL\n| where SyslogMessage contains '<EPOevent>'\n| extend EventVendor = 'McAfee'\n| extend EventProduct = 'McAfee ePO'\n| extend DvcHostname = extract(@'\\<MachineName\\>(.*?)\\<\\/MachineName\\>', 1, SyslogMessage)\n| extend AgentGuid = extract(@'\\<AgentGUID\\>(.*?)\\<\\/AgentGUID\\>', 1, SyslogMessage)\n| extend DvcIpAddr = extract(@'\\<IPAddress\\>(.*?)\\<\\/IPAddress\\>', 1, SyslogMessage)\n| extend SrcDvcOs = extract(@'\\<OSName\\>(.*?)\\<\\/OSName\\>', 1, SyslogMessage)\n| extend DvcMacAddr = extract(@'\\<RawMACAddress\\>(.*?)\\<\\/RawMACAddress\\>', 1, SyslogMessage)\n| extend SrcUserName = extract(@'\\<UserName\\>(.*?)\\<\\/UserName\\>', 1, SyslogMessage)\n| extend TimeZoneBias = extract(@'\\<TimeZoneBias\\>(.*?)\\<\\/TimeZoneBias\\>', 1, SyslogMessage)\n| extend ProductName = extract(@'ProductName=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend ProductFamily = extract(@'ProductFamily=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend ProductVersion = extract(@'ProductVersion=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend Analyzer = extract(@'\\<Analyzer\\>(.*?)\\<\\/Analyzer\\>', 1, SyslogMessage)\n| extend AnalyzerName = extract(@'\\<AnalyzerName\\>(.*?)\\<\\/AnalyzerName\\>', 1, SyslogMessage)\n| extend AnalyzerVersion = extract(@'\\<AnalyzerVersion\\>(.*?)\\<\\/AnalyzerVersion\\>', 1, SyslogMessage)\n| extend AnalyzerHostName = extract(@'\\<AnalyzerHostName\\>(.*?)\\<\\/AnalyzerHostName\\>', 1, SyslogMessage)\n| extend AnalyzerDatVersion = extract(@'\\<AnalyzerDATVersion\\>(.*?)\\<\\/AnalyzerDATVersion\\>', 1, SyslogMessage)\n| extend AnalyzerEngineVersion = extract(@'\\<AnalyzerEngineVersion\\>(.*?)\\<\\/AnalyzerEngineVersion\\>', 1, SyslogMessage)\n| extend AnalyzerDetectionMethod = extract(@'\\<AnalyzerDetectionMethod\\>(.*?)\\<\\/AnalyzerDetectionMethod\\>', 1, SyslogMessage)\n| extend EventId = extract(@'\\<EventID\\>(.*?)\\<\\/EventID\\>', 1, SyslogMessage)\n| extend EventSeverity = extract(@'\\<Severity\\>(.*?)\\<\\/Severity\\>', 1, SyslogMessage)\n| extend EventSeverity = case(EventSeverity == 1, \"Warning\",\n                              EventSeverity == 2, \"Notice\",\n                              EventSeverity == 3, \"Alert\",\n                              EventSeverity == 4, \"Critical\",\n                              \"Information\")\n| extend GmtTime = todatetime(extract(@'\\<GMTTime\\>(.*?)\\<\\/GMTTime\\>', 1, SyslogMessage))\n| extend DetectedUtc = todatetime(extract(@'\\<DetectedUTC\\>(.*?)\\<\\/DetectedUTC\\>', 1, SyslogMessage))\n| extend ThreatName = extract(@'\\<ThreatName\\>(.*?)\\<\\/ThreatName\\>', 1, SyslogMessage)\n| extend ThreatType = extract(@'\\<ThreatType\\>(.*?)\\<\\/ThreatType\\>', 1, SyslogMessage)\n| extend ThreatCategory = extract(@'\\<ThreatCategory\\>(.*?)\\<\\/ThreatCategory\\>', 1, SyslogMessage)\n| extend ThreatId = extract(@'\\<ThreatEventID\\>(.*?)\\<\\/ThreatEventID\\>', 1, SyslogMessage)\n| extend ThreatHandled = extract(@'\\<ThreatHandled\\>(.*?)\\<\\/ThreatHandled\\>', 1, SyslogMessage)\n| extend ThreatActionTaken = extract(@'\\<ThreatActionTaken\\>(.*?)\\<\\/ThreatActionTaken\\>', 1, SyslogMessage)\n| extend ThreatSeverity = extract(@'\\<ThreatSeverity\\>(.*?)\\<\\/ThreatSeverity\\>', 1, SyslogMessage)\n| extend SrcUserUpn = extract(@'\\<SourceUserName\\>(.*?)\\<\\/SourceUserName\\>', 1, SyslogMessage)\n| extend SrcProcessName = extract(@'\\<SourceProcessName\\>(.*?)\\<\\/SourceProcessName\\>', 1, SyslogMessage)\n| extend DstDvcHostname = extract(@'\\<TargetHostName\\>(.*?)\\<\\/TargetHostName\\>', 1, SyslogMessage)\n| extend DstUserName = extract(@'\\<TargetUserName\\>(.*?)\\<\\/TargetUserName\\>', 1, SyslogMessage)\n| extend TargetProcessName = extract(@'\\<TargetProcessName\\>(.*?)\\<\\/TargetProcessName\\>', 1, SyslogMessage)\n| extend DstFileName = extract(@'\\<TargetFileName\\>(.*?)\\<\\/TargetFileName\\>', 1, SyslogMessage)\n| extend Target = extract(@'\\<CustomFields target=\\\"(.*?)\\\"\\>', 1, SyslogMessage)\n| extend BladeName = extract(@'\\<BladeName\\>(.*?)\\<\\/BladeName\\>', 1, SyslogMessage)\n| extend AnalyzerContentVersion = extract(@'\\<AnalyzerContentVersion\\>(.*?)\\<\\/AnalyzerContentVersion\\>', 1, SyslogMessage)\n| extend AnalyzerContentCreationDate = todatetime(extract(@'\\<AnalyzerContentCreationDate\\>(.*?)\\<\\/AnalyzerContentCreationDate\\>', 1, SyslogMessage))\n| extend AnalyzerRuleName = extract(@'\\<AnalyzerRuleName\\>(.*?)\\<\\/AnalyzerRuleName\\>', 1, SyslogMessage)\n| extend AnalyzerRuleId = extract(@'\\<AnalyzerRuleID\\>(.*?)\\<\\/AnalyzerRuleID\\>', 1, SyslogMessage)\n| extend AnalyzerGtiQuery = extract(@'\\<AnalyzerGTIQuery\\>(.*?)\\<\\/AnalyzerGTIQuery\\>', 1, SyslogMessage)\n| extend ThreatDetectedOnCreation = extract(@'\\<ThreatDetectedOnCreation\\>(.*?)\\<\\/ThreatDetectedOnCreation\\>', 1, SyslogMessage)\n| extend DstFileSize = extract(@'\\<TargetFileSize\\>(.*?)\\<\\/TargetFileSize\\>', 1, SyslogMessage)\n| extend DstFileModifiedTime = extract(@'\\<TargetModifyTime\\>(.*?)\\<\\/TargetModifyTime\\>', 1, SyslogMessage)\n| extend DstFileAccessedTime = extract(@'\\<TargetAccessTime\\>(.*?)\\<\\/TargetAccessTime\\>', 1, SyslogMessage)\n| extend DstFileCreationTime = extract(@'\\<TargetCreateTime\\>(.*?)\\<\\/TargetCreateTime\\>', 1, SyslogMessage)\n| extend Cleanable = extract(@'\\<Cleanable\\>(.*?)\\<\\/Cleanable\\>', 1, SyslogMessage)\n| extend TaskName = extract(@'\\<TaskName\\>(.*?)\\<\\/TaskName\\>', 1, SyslogMessage)\n| extend FirstAttemptedAction = extract(@'\\<FirstAttemptedAction\\>(.*?)\\<\\/FirstAttemptedAction\\>', 1, SyslogMessage)\n| extend FirstActionStatus = extract(@'\\<FirstActionStatus\\>(.*?)\\<\\/FirstActionStatus\\>', 1, SyslogMessage)\n| extend SecondAttemptedAction = extract(@'\\<SecondAttemptedAction\\>(.*?)\\<\\/SecondAttemptedAction\\>', 1, SyslogMessage)\n| extend SecondActionStatus = extract(@'\\<SecondActionStatus\\>(.*?)\\<\\/SecondActionStatus\\>', 1, SyslogMessage)\n| extend ApiName = extract(@'\\<APIName\\>(.*?)\\<\\/APIName\\>', 1, SyslogMessage)\n| extend SourceDescription = extract(@'\\<SourceDescription\\>(.*?)\\<\\/SourceDescription\\>', 1, SyslogMessage)\n| extend SrcProcessId = extract(@'\\<SourceProcessID\\>(.*?)\\<\\/SourceProcessID\\>', 1, SyslogMessage)\n| extend SrcProcessHashMd5 = extract(@'\\<SourceProcessHash\\>([a-fA-F0-9]{32})\\<', 1, SyslogMessage)\n| extend AttackVectorType = extract(@'\\<AttackVectorType\\>(.*?)\\<\\/AttackVectorType\\>', 1, SyslogMessage)\n| extend DurationBeforeDetection = extract(@'\\<DurationBeforeDetection\\>(.*?)\\<\\/DurationBeforeDetection\\>', 1, SyslogMessage)\n| extend NaturalLangDescription = extract(@'\\<NaturalLangDescription\\>(.*?)\\<\\/NaturalLangDescription\\>', 1, SyslogMessage)\n| extend AccessRequested = extract(@'\\<AccessRequested\\>(.*?)\\</\\AccessRequested\\>', 1, SyslogMessage)\n| extend DetectionMessage = extract(@'\\<DetectionMessage\\>(.*?)\\</\\DetectionMessage\\>', 1, SyslogMessage)\n| extend AmCoreContentVersion = extract(@'\\<AMCoreContentVersion\\>(.*?)\\</\\AMCoreContentVersion\\>', 1, SyslogMessage)\n| extend SrcIpAddr = extract(@'\\<SourceIPV4\\>(.*?)\\<\\/SourceIPV4\\>', 1, SyslogMessage)\n| extend SrcMacAddr = extract(@'\\<SourceMAC\\>(.*?)\\<\\/SourceMAC\\>', 1, SyslogMessage)\n| extend DstIpAddr = extract(@'\\<TargetIPV4\\>(.*?)\\<\\/TargetIPV4\\>', 1, SyslogMessage)\n| extend DstMacAddr = extract(@'\\<TargetMAC\\>(.*?)\\<\\/TargetMAC\\>', 1, SyslogMessage)\n};\nlet mcafee_updateevent =() {\nSyslog\n| where SyslogMessage contains '<UpdateEvents>'\n| extend EventVendor = 'McAfee'\n| extend EventProduct = 'McAfee ePO'\n| extend AgentGuid = extract(@'\\<AgentGUID\\>(.*?)\\<\\/AgentGUID\\>', 1, SyslogMessage)\n| extend DvcHostname = extract(@'\\<MachineName\\>(.*?)\\<\\/MachineName\\>', 1, SyslogMessage)\n| extend DvcMacAddr = extract(@'\\<RawMACAddress\\>(.*?)\\<\\/RawMACAddress\\>', 1, SyslogMessage)\n| extend DvcIpAddr = extract(@'\\<IPAddress\\>(.*?)\\<\\/IPAddress\\>', 1, SyslogMessage)\n| extend AgentVersion = extract(@'\\<AgentVersion\\>(.*?)\\<\\/AgentVersion\\>', 1, SyslogMessage)\n| extend SrcUserName = extract(@'\\<UserName\\>(.*?)\\<\\/UserName\\>', 1, SyslogMessage)\n| extend TimeZoneBias = extract(@'\\<TimeZoneBias\\>(.*?)\\<\\/TimeZoneBias\\>', 1, SyslogMessage)\n| extend ProductName = extract(@'ProductName=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend ProductFamily = extract(@'ProductFamily=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend ProductVersion = extract(@'ProductVersion=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend EventId = extract(@'\\<EventID\\>(.*?)\\<\\/EventID\\>', 1, SyslogMessage)\n| extend EventSeverity = extract(@'\\<Severity\\>(.*?)\\<\\/Severity\\>', 1, SyslogMessage)\n| extend EventSeverity = case(EventSeverity == 1, \"Warning\",\n                              EventSeverity == 2, \"Notice\",\n                              EventSeverity == 3, \"Alert\",\n                              EventSeverity == 4, \"Critical\",\n                              \"Information\")\n| extend GmtTime = todatetime(extract(@'\\<GMTTime\\>(.*?)\\<\\/GMTTime\\>', 1, SyslogMessage))\n| extend ProductId = extract(@'\\<ProductID\\>(.*?)\\<\\/ProductID\\>', 1, SyslogMessage)\n| extend Locale = extract(@'\\<Locale\\>(.*?)\\<\\/Locale\\>', 1, SyslogMessage)\n| extend Error = extract(@'\\<Error\\>(.*?)\\<\\/Error\\>', 1, SyslogMessage)\n| extend Type = extract(@'\\<Type\\>(.*?)\\<\\/Type\\>', 1, SyslogMessage)\n| extend Version = extract(@'\\<Version\\>(.*?)\\<\\/Version\\>', 1, SyslogMessage)\n| extend InitiatorId = extract(@'\\<InitiatorID\\>(.*?)\\<\\/InitiatorID\\>', 1, SyslogMessage)\n| extend InitiatorType = extract(@'\\<InitiatorType\\>(.*?)\\<\\/InitiatorType\\>', 1, SyslogMessage)\n| extend SiteName = extract(@'\\<SiteName\\>(.*?)\\<\\/SiteName\\>', 1, SyslogMessage)\n| extend Description = extract(@'\\<Description\\>(.*?)\\<\\/Description\\>', 1, SyslogMessage)\n};\nunion isfuzzy=true mcafee_epoevent, mcafee_updateevent\n| project TimeGenerated\n        , GmtTime\n        , EventVendor\n        , EventProduct\n        , EventId\n        , EventSeverity\n        , AgentGuid\n        , DvcHostname\n        , DvcIpAddr\n        , DvcMacAddr\n        , AgentVersion\n        , SrcDvcOs\n        , SrcUserName\n        , TimeZoneBias\n        , ProductName\n        , ProductFamily\n        , ProductVersion\n        , Analyzer\n        , AnalyzerName\n        , AnalyzerVersion\n        , AnalyzerHostName\n        , AnalyzerDatVersion\n        , AnalyzerEngineVersion\n        , AnalyzerDetectionMethod\n        , ThreatName\n        , ThreatType\n        , ThreatCategory\n        , ThreatId\n        , ThreatHandled\n        , ThreatActionTaken\n        , ThreatSeverity\n        , SrcUserUpn\n        , SrcProcessName\n        , DstDvcHostname\n        , DstUserName\n        , TargetProcessName\n        , DstFileName\n        , Target\n        , BladeName\n        , AnalyzerContentVersion\n        , AnalyzerContentCreationDate\n        , AnalyzerRuleName\n        , AnalyzerRuleId\n        , AnalyzerGtiQuery\n        , ThreatDetectedOnCreation\n        , DstFileSize\n        , DstFileModifiedTime\n        , DstFileAccessedTime\n        , DstFileCreationTime\n        , Cleanable\n        , TaskName\n        , FirstAttemptedAction\n        , FirstActionStatus\n        , SecondAttemptedAction\n        , SecondActionStatus\n        , ApiName\n        , SourceDescription\n        , SrcProcessId\n        , SrcProcessHashMd5\n        , AttackVectorType\n        , DurationBeforeDetection\n        , AccessRequested\n        , DetectionMessage\n        , AmCoreContentVersion\n        , SrcIpAddr\n        , SrcMacAddr\n        , DstIpAddr\n        , DstMacAddr\n        , ProductId\n        , Locale\n        , Error\n        , Type\n        , Version\n        , InitiatorId\n        , InitiatorType\n        , SiteName\n        , Description",
            "version": 1
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 1",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Agent Errors",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nMcAfeeEPOEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('2402', '2412', '1119', '1123', '2201', '2202', '2204', '2208', '3020', '3021')\n| extend EventMessage = case(EventId == '2402', \"Update Failed\",\n                              EventId == '2412', \"Deployment Failed\",\n                              EventId == '1119', \n                              \"The update failed; see event log\",\n                              EventId == '1123', \"The upgrade failed; see event log\",\n                              EventId == '2201', \"McAfee Agent: Failed to install software package\",\n                              EventId == '2202', \"McAfee Agent: Install retry limit reached for software package\",\n                              EventId == '2204', \"McAfee Agent: Insufficient disk space to install software\", \n                              EventId == '2208', \"McAfee Agent: Insufficient disk space to download software\",\n                              EventId == '3020', \"Invalid virus signature files\",\n                              \"Scan engine error\")\n| project DvcIpAddr, EventId, EventMessage\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for error events from McAfee agents."
              },
              {
                "name": "tactics",
                "value": "DefenseEvasion"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 2",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Applications blocked or contained",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nMcAfeeEPOEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('18002', '37275')\n| extend Reason = case(EventId == '18002', \"Application blocked\",\n                      \"Application contained\")\n| project DvcIpAddr, DstFileName\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for blocked or contained applications."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,Execution"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 3",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Email Treats",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nMcAfeeEPOEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('1417', '1418', '1419', '1420', '1500', '1501', '1502', '1503', '1504', '1505', '1506', '1507', '1513', '1514')\n| extend EventMessage = case(EventId == '1417', \"Email message deleted (user defined detection)\",\n                              EventId == '1418', \"Email message deleted (user defined detection), Clean failed\",\n                              EventId == '1419', \n                              \"Email message deleted (user defined detection), Move failed\",\n                              EventId == '1420', \"Email message deleted (user defined detection), Delete failed\",\n                              EventId == '1500', \"Infected email cleaned (Medium)\",\n                              EventId == '1501', \"Infected email quarantined\",\n                              EventId == '1502', \"Unable to clean infected mail\", \n                              EventId == '1503', \"Infected email detected\",\n                              EventId == '1504', \"Infected mail item deleted\",\n                              EventId == '1505', \"Email content filtered\",\n                              EventId == '1506', \"Email content blocked\",\n                              EventId == '1507', \"Inbound email suspended for low disk\",\n                              EventId == '1513', \"Mail virus quarantined and cleaned\",\n                              \"Mail virus quarantined (not cleaned)\")\n| project DvcIpAddr, EventId, EventMessage\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for email related threat events."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 4",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Infected files by source",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nMcAfeeEPOEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('1024', '1053', '2000', '3004')\n| summarize ['Infected Files List'] = makeset(DstFileName) by DvcIpAddr\n| project DvcIpAddr, ['Infected Files List']\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for infected files which were detected."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 5",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Infected Systems",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nMcAfeeEPOEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('1038', '3043')\n| project DvcIpAddr, DvcHostname\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for infected systems based on scan results."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 6",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Long term infected systems",
            "category": "Hunting Queries",
            "query": "let lbperiod_30d = 30d;\nlet infected_systems = McAfeeEPOEvent\n| where TimeGenerated > ago(lbperiod_30d)\n| where EventId in ('1038', '3043')\n| summarize LastScanTimeInfected = max(TimeGenerated) by DvcIpAddr\n| extend SystemStatus = 'Infected';\nlet clean_systems = McAfeeEPOEvent\n| where TimeGenerated > ago(lbperiod_30d - 1h)\n| where EventId in ('1034', '3039')\n| summarize LastScanTimeClean = max(TimeGenerated) by DvcIpAddr\n| extend SystemStatus = 'Clean';\nlet clean_systems2 = McAfeeEPOEvent\n| where TimeGenerated > ago(lbperiod_30d - 1h)\n| where EventId in ('1034', '3039')\n| summarize makeset(DvcIpAddr);\ninfected_systems\n| extend tmp_key = 1\n| join (clean_systems\n          | extend tmp_key = 1) on tmp_key\n| where  LastScanTimeInfected > LastScanTimeClean or DvcIpAddr !in (clean_systems2)\n| project LastScanTimeInfected, DvcIpAddr\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for infected systems which were not cleaned for long term."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,Persistence"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 7",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Sources with multiple threats",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nlet threshold = 1;\nMcAfeeEPOEvent\n| where TimeGenerated > ago(lbtime)\n| where isnotempty(ThreatName)\n| where ThreatName != '_'\n| summarize ThreatList = makeset(ThreatName) by DvcIpAddr\n| where array_len(ThreatList) > threshold\n| project DvcIpAddr, ThreatList\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for sources with several different threats."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 8",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Objects not scanned",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nMcAfeeEPOEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('1051', '34925', '34926')\n| extend Reason = case(EventId == '1051', \"Unable to scan password protected\",\n                              EventId == '34925', \"The object was not scanned because the scanner does not have enough rights to read it\",\n                              \"The object was not scanned because the file size exceeds the configured maximum file size to scan\")\n| project DvcIpAddr, EventId, Reason, DstFileName\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for unscanned objects."
              },
              {
                "name": "tactics",
                "value": "DefenseEvasion"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 9",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Scan Errors",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nMcAfeeEPOEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('3021', '1086', '1059', '1128', '1035', '1051', '1048', '1049', '3053', '3054', '3046')\n| extend Reason = case(EventId == '3021', \"Scan engine error\",\n                              EventId == '1086', \"Scan Process Error\",\n                              EventId == '1059', \"Scan Timed Out\",\n                              EventId == '1128', \"Scan time exceeded\",\n                              EventId == '1035', \"Scan was canceled\",\n                              EventId == '1051', \"Unable to scan password protected\",\n                              EventId == '1048', \"Scan reports general system error\",\n                              EventId == '1049', \"Scan reported an internal application error\",\n                              EventId == '3053', \"Centralized Alerting - Scan reports general system error\",\n                              EventId == '3054', \"Centralized Alerting - Scan reported an internal application error\",\n                              \"Centralized Alerting - Scan reports memory allocation error\")\n| project DvcIpAddr, EventId, Reason\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for scan error events."
              },
              {
                "name": "tactics",
                "value": "DefenseEvasion"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "McAfeeePO Hunting Query 10",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "McAfee ePO - Threats detected and not blocked, cleaned or deleted",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nMcAfeeEPOEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('1095', '1096', '1099', '34937', '35102', '34938', '35106', '35111', '35117')\n| extend EventMessage = case(EventId == '1095', \"Access Protection rule violation detected and NOT blocked\",\n                              EventId == '1096', \"Port blocking rule violation detected and NOT blocked\",\n                              EventId == '1099', \n                              \"Buffer Overflow detected and NOT blocked\",\n                              EventId == '34937', \"Script security violation detected, AMSI would block\",\n                              EventId == '35102', \"Adaptive Threat Protection Would Block\",\n                              EventId == '34938', \"Script security violation detected, AMSI would delete\",\n                              EventId == '35106', \"Adaptive Threat Protection Would Clean\", \n                              EventId == '35111', \"Adaptive Threat Protection Would Contain\",\n                              \"Adaptive Threat Protection Would Block Source\")\n| project DvcIpAddr, EventId, EventMessage\n| extend IPCustomEntity = DvcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for events where threats were detected and not blocked, cleaned or deleted."
              },
              {
                "name": "tactics",
                "value": "Persistence,PrivilegeEscalation"
              }
            ]
          }
        }
      ]
    }
  ],
  "outputs": {}
}
